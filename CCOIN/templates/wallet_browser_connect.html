<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Connect Phantom Wallet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            text-align: center;
            padding: 50px 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 40px;
            border-radius: 20px;
        }
        .btn {
            background: linear-gradient(135deg, #AB9FF2, #7B68EE);
            color: white;
            border: none;
            padding: 20px 30px;
            border-radius: 25px;
            font-size: 18px;
            cursor: pointer;
            width: 100%;
            margin: 15px 0;
            text-decoration: none;
            display: inline-block;
            box-sizing: border-box;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .btn:hover {
            background: linear-gradient(135deg, #9A8CF1, #6A5ACD);
            transform: translateY(-2px);
        }
        .debug {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 12px;
            text-align: left;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
        }
        .status {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶Ñ Connect Phantom Wallet</h1>
        <p>Click the button below to open this page in Phantom app where your wallet will be automatically connected.</p>
        
        <button class="btn" onclick="openInPhantom()">
            ü¶Ñ Open in Phantom App
        </button>
        
        <div id="status" class="status" style="display: none;">
            Ready to connect...
        </div>
        
        <div id="debug" class="debug" style="display: none;"></div>
    </div>

    <script>
        var attemptCount = 0;
        var maxAttempts = 1; // ŸÅŸÇÿ∑ €å⁄© ÿ®ÿßÿ± ÿ™ŸÑÿßÿ¥ ⁄©ŸÜ
        
        function log(msg) {
            console.log(msg);
            var debug = document.getElementById('debug');
            if (debug) {
                debug.style.display = 'block';
                debug.innerHTML += '[' + new Date().toLocaleTimeString() + '] ' + msg + '<br>';
                debug.scrollTop = debug.scrollHeight;
            }
        }

        function showStatus(msg) {
            var status = document.getElementById('status');
            if (status) {
                status.style.display = 'block';
                status.textContent = msg;
            }
        }
        
        function openInPhantom() {
            attemptCount++;
            log(`üöÄ Attempt ${attemptCount}: Starting Phantom app connection...`);
            showStatus('Opening Phantom app...');
            
            var currentUrl = window.location.href;
            log('üìç Current URL: ' + currentUrl);
            
            // ÿß⁄Øÿ± ŸÇÿ®ŸÑÿßŸã ÿØÿ± Phantom browser Ÿáÿ≥ÿ™€åŸÖ
            if (window.solana && window.solana.isPhantom) {
                log('‚úÖ Already in Phantom browser, connecting directly');
                connectDirectly();
                return;
            }
            
            // ‚úÖ **ÿßÿµŸÑÿßÿ≠ ⁄©ŸÑ€åÿØ€å: ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ deep link ÿµÿ≠€åÿ≠**
            // ÿßÿ≤ browse ÿ®Ÿá ÿ¨ÿß€å connect ÿßÿ≥ÿ™ŸÅÿßÿØŸá ⁄©ŸÜ ÿ™ÿß ÿµŸÅÿ≠Ÿá ÿØÿ± ÿßŸæ ÿ®ÿßÿ≤ ÿ¥ŸàÿØ
            var phantomAppUrl = `phantom://ul/browse/${encodeURIComponent(currentUrl)}`;
            log('üîó Using browse deep link: ' + phantomAppUrl);
            
            // ‚úÖ **ÿ™ÿ∫€å€åÿ± ŸÖŸáŸÖ: ŸÖÿ≥ÿ™ŸÇ€åŸÖÿßŸã ÿ®Ÿá ÿßŸæ ÿ®ÿ±Ÿà**
            try {
                showStatus('ü¶Ñ Opening Phantom app... Please wait.');
                
                // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ window.location.href ÿ®ÿ±ÿß€å ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ÿßŸæ
                window.location.href = phantomAppUrl;
                
                log('üì± Redirected to Phantom app successfully');
                
                // ‚úÖ **ÿ≠ÿ∞ŸÅ fallback**: Ÿá€å⁄Ü fallback ÿ®Ÿá web ŸÜÿØÿßÿ¥ÿ™Ÿá ÿ®ÿßÿ¥
                // ÿ™ÿß ÿßŸæ ŸÖÿ¨ÿ®Ÿàÿ± ÿ¥ŸàÿØ ÿ®ÿßÿ≤ ÿ¥ŸàÿØ
                
            } catch (error) {
                log('‚ùå Error opening Phantom app: ' + error.message);
                showStatus('‚ùå Failed to open Phantom app. Please install Phantom.');
            }
        }
        
        async function connectDirectly() {
            try {
                log('üîå Inside Phantom browser, connecting wallet...');
                showStatus('üîó Connecting wallet...');
                
                // ‚úÖ **ÿßÿµŸÑÿßÿ≠: ÿßÿ∂ÿßŸÅŸá ⁄©ÿ±ÿØŸÜ ÿ™ÿßÿÆ€åÿ± ÿ®ÿ±ÿß€å ÿßÿ∑ŸÖ€åŸÜÿßŸÜ ÿßÿ≤ ÿ¢ŸÖÿßÿØŸá ÿ®ŸàÿØŸÜ ÿßŸæ**
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ ÿßÿ™ÿµÿßŸÑ
                const response = await window.solana.connect();
                const walletAddress = response.publicKey.toString();
                
                log('‚úÖ Wallet connected: ' + walletAddress);
                showStatus('‚úÖ Wallet connected! Saving...');
                
                // ÿßÿ±ÿ≥ÿßŸÑ ÿ¢ÿØÿ±ÿ≥ ÿ®Ÿá ÿ≥ÿ±Ÿàÿ±
                var params = new URLSearchParams(window.location.search);
                var telegramId = params.get('telegram_id');
                
                if (!telegramId) {
                    log('‚ùå Error: Missing telegram ID');
                    showStatus('‚ùå Error: Missing telegram ID');
                    return;
                }
                
                log('üì§ Sending wallet address to server...');
                
                const apiResponse = await fetch('/api/wallet/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: telegramId,
                        wallet_address: walletAddress
                    })
                });
                
                const data = await apiResponse.json();
                
                if (apiResponse.ok && data.success) {
                    log('‚úÖ Wallet saved successfully, redirecting to airdrop...');
                    showStatus('‚úÖ Success! Redirecting...');
                    
                    // ÿ™ÿßÿÆ€åÿ± ⁄©Ÿàÿ™ÿßŸá ŸÇÿ®ŸÑ ÿßÿ≤ redirect
                    setTimeout(() => {
                        window.location.href = '/airdrop?telegram_id=' + telegramId;
                    }, 1000);
                    
                } else {
                    log('‚ùå Error saving wallet: ' + (data.detail || 'Server error'));
                    showStatus('‚ùå Error: ' + (data.detail || 'Server error'));
                }
                
            } catch (error) {
                log('‚ùå Error connecting wallet: ' + error.message);
                console.error('Error connecting wallet:', error);
                showStatus('‚ùå Connection failed: ' + error.message);
                
                // ‚úÖ **ÿßÿ∂ÿßŸÅŸá: retry button ÿØÿ± ÿµŸàÿ±ÿ™ ÿÆÿ∑ÿß**
                if (attemptCount < maxAttempts) {
                    setTimeout(() => {
                        log('üîÑ Auto-retry in 2 seconds...');
                        showStatus('üîÑ Retrying connection...');
                        connectDirectly();
                    }, 2000);
                }
            }
        }
        
        // ⁄Ü⁄© ⁄©ÿ±ÿØŸÜ ŸÖÿ≠€åÿ∑ ŸáŸÜ⁄ØÿßŸÖ ÿ®ÿßÿ±⁄Øÿ∞ÿßÿ±€å
        window.addEventListener('load', function() {
            log('üîç Page loaded, checking environment...');
            
            if (window.solana && window.solana.isPhantom) {
                log('‚úÖ Phantom browser detected - auto-connecting');
                
                // ÿ™ÿ∫€å€åÿ± UI ÿ®ÿ±ÿß€å ÿ≠ÿßŸÑÿ™ Phantom browser
                document.querySelector('h1').textContent = 'ü¶Ñ Phantom Wallet Ready';
                document.querySelector('p').textContent = 'Perfect! You are in Phantom app. Connecting your wallet automatically...';
                document.querySelector('.btn').style.display = 'none';
                
                showStatus('üîó Auto-connecting wallet...');
                
                // ‚úÖ **ÿßÿ™ÿµÿßŸÑ ÿÆŸàÿØ⁄©ÿßÿ± ÿ®ÿß ÿ™ÿßÿÆ€åÿ± ⁄©Ÿàÿ™ÿßŸá**
                setTimeout(() => {
                    connectDirectly();
                }, 1000);
                
            } else {
                log('üì± External browser detected');
                showStatus('Click the button to open Phantom app');
            }
            
            var params = new URLSearchParams(window.location.search);
            var telegramId = params.get('telegram_id');
            log('üë§ Telegram ID: ' + (telegramId || 'Not found'));
        });
    </script>
</body>
</html>
