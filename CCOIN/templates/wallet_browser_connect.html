<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connect Phantom Wallet</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        .connect-btn {
            background: #4C44FF;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            width: 100%;
        }
        .check-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            width: 100%;
        }
        .manual-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            width: 100%;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .waiting { background: #fff3cd; color: #856404; }
        .instructions {
            background: #e9ecef;
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: left;
        }
        .step {
            margin: 10px 0;
            padding: 5px 0;
        }
        .step-number {
            background: #4C44FF;
            color: white;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîó Connect Phantom Wallet</h1>
        
        <div id="status" class="status info">
            Ready to connect...
        </div>

        <div id="connection-step" style="display: block;">
            <p>Choose your connection method:</p>
            
            <button onclick="tryAutoConnect()" class="connect-btn" id="autoConnectBtn">
                üöÄ Try Auto Connect
            </button>

            <button onclick="showManualInstructions()" class="manual-btn" id="manualBtn">
                üìã Manual Connection Guide
            </button>
        </div>

        <div id="manual-instructions" style="display: none;">
            <div class="instructions">
                <h3>Manual Connection Steps:</h3>
                <div class="step">
                    <span class="step-number">1</span>
                    Open Phantom app on your phone manually
                </div>
                <div class="step">
                    <span class="step-number">2</span>
                    Go to Settings ‚Üí Connected Apps
                </div>
                <div class="step">
                    <span class="step-number">3</span>
                    Tap "+" to add new connection
                </div>
                <div class="step">
                    <span class="step-number">4</span>
                    Enter this URL: <strong>{{ request.url.scheme }}://{{ request.url.netloc }}</strong>
                </div>
                <div class="step">
                    <span class="step-number">5</span>
                    Approve the connection
                </div>
                <div class="step">
                    <span class="step-number">6</span>
                    Return here and click "Check Connection"
                </div>
            </div>

            <button onclick="checkConnection()" class="check-btn" id="checkBtn">
                ‚úÖ Check Connection Status
            </button>

            <button onclick="showConnectionStep()" class="connect-btn">
                ‚¨ÖÔ∏è Back to Auto Connect
            </button>
        </div>

        <div id="waiting-step" style="display: none;">
            <p>‚è≥ Connection attempt in progress...</p>
            <p>Please check your Phantom app and approve the connection.</p>
            
            <button onclick="checkConnection()" class="check-btn">
                ‚úÖ I've approved, check status
            </button>

            <button onclick="showConnectionStep()" class="connect-btn">
                ‚¨ÖÔ∏è Try different method
            </button>
        </div>

        <p><small>After connecting, you can close this browser and return to the Telegram app.</small></p>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const telegramId = urlParams.get('telegram_id');
        let checkInterval = null;

        function showConnectionStep() {
            document.getElementById('connection-step').style.display = 'block';
            document.getElementById('manual-instructions').style.display = 'none';
            document.getElementById('waiting-step').style.display = 'none';
            document.getElementById('status').textContent = 'Choose your connection method:';
            document.getElementById('status').className = 'status info';
        }

        function showManualInstructions() {
            document.getElementById('connection-step').style.display = 'none';
            document.getElementById('manual-instructions').style.display = 'block';
            document.getElementById('waiting-step').style.display = 'none';
            document.getElementById('status').textContent = 'Follow these steps to connect manually:';
            document.getElementById('status').className = 'status info';
        }

        function showWaitingStep() {
            document.getElementById('connection-step').style.display = 'none';
            document.getElementById('manual-instructions').style.display = 'none';
            document.getElementById('waiting-step').style.display = 'block';
        }

        async function tryAutoConnect() {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = "Attempting to open Phantom app...";
            statusDiv.className = "status info";

            // ÿ™ŸÑÿßÿ¥ ÿ®ÿ±ÿß€å ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ ÿßŸæ
            const phantom_url = 'phantom://';
            const link = document.createElement('a');
            link.href = phantom_url;
            link.click();

            // ÿ®ÿπÿØ ÿßÿ≤ 2 ÿ´ÿßŸÜ€åŸá ÿ®Ÿá ŸÖÿ±ÿ≠ŸÑŸá ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ®ÿ±Ÿà€åŸÖ
            setTimeout(() => {
                showWaitingStep();
                statusDiv.textContent = "If Phantom opened, please approve the connection, then check status.";
                statusDiv.className = "status waiting";
                
                // ÿ¥ÿ±Ÿàÿπ ⁄Ü⁄© ÿÆŸàÿØ⁄©ÿßÿ± Ÿáÿ± 3 ÿ´ÿßŸÜ€åŸá
                checkInterval = setInterval(checkConnection, 3000);
            }, 2000);
        }

        async function checkConnection() {
            const statusDiv = document.getElementById('status');
            
            try {
                statusDiv.textContent = "Checking connection status...";
                statusDiv.className = "status info";

                const response = await fetch(`/api/wallet/status?telegram_id=${telegramId}`);
                const data = await response.json();
                
                if (data.connected && data.address) {
                    statusDiv.textContent = `‚úÖ Successfully connected!\nWallet: ${data.address.substring(0,8)}...${data.address.substring(-8)}`;
                    statusDiv.className = "status success";
                    
                    // ŸÖÿ™ŸàŸÇŸÅ ⁄©ÿ±ÿØŸÜ ⁄Ü⁄© ÿÆŸàÿØ⁄©ÿßÿ±
                    if (checkInterval) {
                        clearInterval(checkInterval);
                        checkInterval = null;
                    }
                    
                    // ŸÖÿÆŸÅ€å ⁄©ÿ±ÿØŸÜ ŸáŸÖŸá ÿØ⁄©ŸÖŸá‚ÄåŸáÿß
                    document.getElementById('connection-step').style.display = 'none';
                    document.getElementById('manual-instructions').style.display = 'none';
                    document.getElementById('waiting-step').style.display = 'none';
                    
                    setTimeout(() => {
                        statusDiv.textContent += "\n\nYou can now close this browser and return to the Telegram app.";
                        
                        // ÿ™ŸÑÿßÿ¥ ÿ®ÿ±ÿß€å ÿ®ÿ≥ÿ™ŸÜ ÿÆŸàÿØ⁄©ÿßÿ± ÿµŸÅÿ≠Ÿá
                        setTimeout(() => {
                            window.close();
                        }, 3000);
                    }, 2000);
                    
                } else {
                    statusDiv.textContent = "‚è≥ Wallet not connected yet. Please approve connection in Phantom app.";
                    statusDiv.className = "status waiting";
                }
            } catch (error) {
                statusDiv.textContent = "‚ùå Error checking connection. Please try again.";
                statusDiv.className = "status error";
                console.error('Connection check error:', error);
            }
        }

        // Ÿæÿß⁄© ⁄©ÿ±ÿØŸÜ interval ŸáŸÜ⁄ØÿßŸÖ ÿÆÿ±Ÿàÿ¨
        window.addEventListener('beforeunload', () => {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
        });
    </script>
</body>
</html>
