<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#FFD700">
    <link rel="icon" href="/static/images/icon.png" type="image/png">
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://ccoin-final.onrender.com/">
    <meta property="og:title" content="CCoin - Telegram Mini App">
    <meta property="og:description" content="Earn CCoin tokens through tasks and referrals">
    <meta property="og:image" content="https://ccoin-final.onrender.com/static/images/icon.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://ccoin-final.onrender.com/">
    <meta property="twitter:title" content="CCoin - Telegram Mini App">  
    <meta property="twitter:description" content="Earn CCoin tokens through tasks and referrals">
    <meta property="twitter:image" content="https://ccoin-final.onrender.com/static/images/icon.png">

    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="/static/images/icon.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/static/images/icon.png">
    <title>Friends</title>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', path='css/friends.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    
    <div class="center-content">
        <img src="{{ url_for('static', path='images/invite.png') }}" class="logo" alt="invite Logo">
        <h1>Invite Friends</h1>
        <p class="subheading">Get 50 CCoin for each friend</p>
    </div>

    <div class="invite-list">
        <h2>Your Invites</h2>
        <div class="invite-box">
            {% if invited_users %}
                {% for user in invited_users %}
                <div class="friend-item">
                    <div class="user-circle">{{ user.first_name[0] }}{{ user.last_name[0] }}</div>
                    <div class="telegram-id">@{{ user.telegram_id }}</div>
                    <div class="tokens">{{ user.tokens }} Tokens</div>
                </div>
                {% endfor %}
            {% else %}
                <p>No friends invited yet!</p>
            {% endif %}
        </div>
    </div>

    <div class="buttons-container">
        <button id="inviteButton" onclick="inviteFunction()">Invite Friends</button>
        <button id="copyButton" onclick="copyFunction()"><i class="fas fa-link"></i></button>
    </div>

    <div class="footer-icons">
        <a href="/leaders" class="footer-btn">
            <i class="fas fa-medal"></i>
            <span>Leaders</span>
        </a>
        <a href="/friends" class="footer-btn active">
            <i class="fas fa-user-friends"></i>
            <span>Friends</span>
        </a>
        <a href="/home" class="footer-btn">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="/earn" class="footer-btn">
            <i class="fas fa-coins"></i>
            <span>Earn</span>
        </a>
        <a href="/airdrop" class="footer-btn">
            <i class="fas fa-gift"></i>
            <span>AirDrop</span>
        </a>
    </div>

    <script>
        // متغیرهای مستقیم
        const REFERRAL_LINK = "{{ referral_link }}";
        const REFERRAL_CODE = "{{ referral_code }}";
        
        console.log("REFERRAL_LINK:", REFERRAL_LINK);
        console.log("REFERRAL_CODE:", REFERRAL_CODE);

        function inviteFunction() {
            console.log("Invite button clicked");
            
            if (!REFERRAL_LINK) {
                alert('Referral link not available');
                return;
            }
            
            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    // روش اول: استفاده از switchInlineQuery برای باز کردن صفحه انتخاب کانتکت
                    if (window.Telegram.WebApp.switchInlineQuery) {
                        console.log("Using switchInlineQuery");
                        window.Telegram.WebApp.switchInlineQuery(REFERRAL_LINK, ['users']);
                        return;
                    }
                    
                    // روش دوم: استفاده از openTelegramLink
                    if (window.Telegram.WebApp.openTelegramLink) {
                        console.log("Using openTelegramLink");
                        const shareUrl = `tg://msg?text=${encodeURIComponent(REFERRAL_LINK)}`;
                        window.Telegram.WebApp.openTelegramLink(shareUrl);
                        return;
                    }
                    
                    // روش سوم: استفاده از openLink
                    if (window.Telegram.WebApp.openLink) {
                        console.log("Using openLink");
                        const shareUrl = `tg://msg?text=${encodeURIComponent(REFERRAL_LINK)}`;
                        window.Telegram.WebApp.openLink(shareUrl);
                        return;
                    }
                    
                    // روش چهارم: fallback
                    console.log("Using fallback method");
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(REFERRAL_LINK)}`;
                    window.Telegram.WebApp.openLink(shareUrl);
                    
                } catch (error) {
                    console.error("Error in invite function:", error);
                    // آخرین fallback
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(REFERRAL_LINK)}`;
                    window.open(shareUrl, '_blank');
                }
            } else {
                console.log("Telegram WebApp not available");
                // برای تست در مرورگر
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(REFERRAL_LINK)}`;
                window.open(shareUrl, '_blank');
            }
        }

        function copyFunction() {
            console.log("Copy button clicked");
            
            if (!REFERRAL_LINK) {
                alert('Referral link not available');
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(REFERRAL_LINK).then(() => {
                    alert('Link copied!');
                }).catch((error) => {
                    console.error("Clipboard failed:", error);
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }
        
        function fallbackCopy() {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = REFERRAL_LINK;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Link copied!');
            } catch (error) {
                console.error("Fallback copy failed:", error);
                alert('Copy failed');
            }
        }

        // Initialize Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            console.log("Telegram WebApp initialized");
        } else {
            console.log("Telegram WebApp not available");
        }
    </script>
</body>
</html>
