<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Friends</title>
    <link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/friends.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    
    <div class="center-content">
        <img src="/static/images/invite.png" class="logo" alt="invite Logo">
        <h1>Invite Friends</h1>
        <p class="subheading">Get 50 CCoin for each friend</p>
    </div>

    <div class="invite-list">
        <h2>Your Invites</h2>
        <div class="invite-box">
            {% if invited_users %}
                {% for user in invited_users %}
                <div class="friend-item">
                    <div class="user-circle">{{ user.first_name[0] }}{{ user.last_name[0] }}</div>
                    <div class="telegram-id">@{{ user.telegram_id }}</div>
                    <div class="tokens">{{ user.tokens }} Tokens</div>
                </div>
                {% endfor %}
            {% else %}
                <p>No friends invited yet!</p>
            {% endif %}
        </div>
    </div>

    <div class="buttons-container">
        <button id="inviteButton" onclick="inviteFunction()">Invite Friends</button>
        <button id="copyButton" onclick="copyFunction()"><i class="fas fa-link"></i></button>
    </div>

    <div class="footer-icons">
        <a href="/leaders" class="footer-btn">
            <i class="fas fa-medal"></i>
            <span>Leaders</span>
        </a>
        <a href="/friends" class="footer-btn active">
            <i class="fas fa-user-friends"></i>
            <span>Friends</span>
        </a>
        <a href="/home" class="footer-btn">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="/earn" class="footer-btn">
            <i class="fas fa-coins"></i>
            <span>Earn</span>
        </a>
        <a href="/airdrop" class="footer-btn">
            <i class="fas fa-gift"></i>
            <span>AirDrop</span>
        </a>
    </div>

    <script>
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø³ØªÙ‚ÛŒÙ…
        const REFERRAL_LINK = "{{ referral_link }}";
        const REFERRAL_CODE = "{{ referral_code }}";
        
        console.log("REFERRAL_LINK:", REFERRAL_LINK);
        console.log("REFERRAL_CODE:", REFERRAL_CODE);

        function inviteFunction() {
            console.log("Invite button clicked");

            if (!REFERRAL_LINK) {
                alert('Referral link not available');
                return;
            }

            const message = `ðŸŽ‰ Join CCoin and get FREE tokens!\n\n${REFERRAL_LINK}`;

            if (window.Telegram && window.Telegram.WebApp) {
                try {
                    // âœ… Ø±ÙˆØ´ ØµØ­ÛŒØ­: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² share link
                    const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(REFERRAL_LINK)}&text=${encodeURIComponent('ðŸŽ‰ Join CCoin and get FREE tokens!')}`;

                    console.log("Opening share URL:", shareUrl);

                    if (window.Telegram.WebApp.openTelegramLink) {
                        window.Telegram.WebApp.openTelegramLink(shareUrl);
                    } else if (window.Telegram.WebApp.openLink) {
                        window.Telegram.WebApp.openLink(shareUrl);
                    } else {
                        window.open(shareUrl, '_blank');
                    }

                } catch (error) {
                    console.error("Error in invite function:", error);
                    alert('Error sharing link: ' + error.message);
                }
            } else {
                console.log("Telegram WebApp not available");
                const shareUrl = `https://t.me/share/url?url=${encodeURIComponent(REFERRAL_LINK)}`;
                window.open(shareUrl, '_blank');
            }
        }

        function copyFunction() {
            console.log("Copy button clicked");
            
            if (!REFERRAL_LINK) {
                alert('Referral link not available');
                return;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(REFERRAL_LINK).then(() => {
                    alert('Link copied!');
                }).catch((error) => {
                    console.error("Clipboard failed:", error);
                    fallbackCopy();
                });
            } else {
                fallbackCopy();
            }
        }
        
        function fallbackCopy() {
            try {
                const textArea = document.createElement('textarea');
                textArea.value = REFERRAL_LINK;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Link copied!');
            } catch (error) {
                console.error("Fallback copy failed:", error);
                alert('Copy failed');
            }
        }

        // Initialize Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            console.log("Telegram WebApp initialized");
        } else {
            console.log("Telegram WebApp not available");
        }
    </script>
</body>
</html>
