<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCoin Airdrop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #000; color: #fff; min-height: 100vh; padding: 20px;
        }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; }
        .logo { width: 80px; height: 80px; margin: 0 auto 20px; background: #333; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 40px; }
        h1 { font-size: 28px; margin-bottom: 10px; }
        .subtitle { color: #999; font-size: 16px; }
        .stats { background: #111; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .stat-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .stat-item:last-child { margin-bottom: 0; }
        .stat-label { color: #999; }
        .stat-value { font-weight: bold; color: #fff; }
        .section { background: #111; border-radius: 15px; padding: 20px; margin-bottom: 20px; }
        .section-title { font-size: 18px; margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
        .status-item { display: flex; align-items: center; gap: 15px; padding: 15px; background: #222; border-radius: 10px; margin-bottom: 10px; }
        .status-item:last-child { margin-bottom: 0; }
        .status-icon { font-size: 24px; }
        .status-content { flex: 1; }
        .status-title { font-weight: bold; margin-bottom: 5px; }
        .status-subtitle { color: #999; font-size: 14px; }
        .status-date { color: #666; font-size: 12px; margin-top: 5px; }
        .completed { border-left: 4px solid #28a745; }
        .pending { border-left: 4px solid #ffc107; }
        .failed { border-left: 4px solid #dc3545; }
        .connect-wallet-btn, .pay-commission-btn, .claim-btn {
            background: #fff; color: #000; border: none; padding: 12px 20px;
            border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%;
            margin-top: 10px; transition: all 0.3s ease;
        }
        .connect-wallet-btn:hover, .pay-commission-btn:hover, .claim-btn:hover { background: #f0f0f0; }
        .connect-wallet-btn:disabled, .pay-commission-btn:disabled, .claim-btn:disabled {
            opacity: 0.6; cursor: not-allowed;
        }
        .wallet-dropdown { position: relative; display: inline-block; width: 100%; margin-top: 10px; }
        .wallet-button { background: #28a745; color: #fff; border: none; padding: 12px 20px; border-radius: 8px; font-weight: bold; cursor: pointer; width: 100%; display: flex; align-items: center; justify-content: space-between; }
        .wallet-content { display: none; position: absolute; background: #222; min-width: 100%; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 8px; margin-top: 5px; border: 1px solid #444; }
        .wallet-content a { color: #fff; padding: 12px 16px; text-decoration: none; display: block; border-bottom: 1px solid #444; }
        .wallet-content a:last-child { border-bottom: none; }
        .wallet-content a:hover { background-color: #333; }
        .wallet-dropdown:hover .wallet-content { display: block; }
        .dropdown-arrow { transition: transform 0.3s ease; }
        .wallet-dropdown:hover .dropdown-arrow { transform: rotate(180deg); }
        .loading { display: none; text-align: center; padding: 20px; color: #999; }
        .error { background: #dc3545; color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .success { background: #28a745; color: #fff; padding: 15px; border-radius: 10px; margin-bottom: 20px; }
        .progress-bar { background: #333; height: 10px; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .progress-fill { background: #28a745; height: 100%; width: 0%; transition: width 0.3s ease; }
        .claim-section { text-align: center; padding: 30px 20px; }
        .claim-amount { font-size: 36px; font-weight: bold; color: #28a745; margin-bottom: 10px; }
        .claim-label { color: #999; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">ü™ô</div>
            <h1>CCoin Airdrop</h1>
            <p class="subtitle">Complete tasks and claim your tokens</p>
        </div>

        <div class="stats">
            <div class="stat-item">
                <span class="stat-label">Your Tokens</span>
                <span class="stat-value" id="userTokens">Loading...</span>
            </div>
            <div class="stat-item">
                <span class="stat-label">Completion</span>
                <span class="stat-value" id="completionPercentage">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">
                üìã Required Tasks
            </div>
            <div id="tasksList">
                <div class="loading">Loading tasks...</div>
            </div>
        </div>

        <div class="section" id="walletSection" style="display: none;">
            <div class="section-title">
                üí≥ Wallet Connection
            </div>
            <div id="walletStatus">
                <div class="loading">Checking wallet status...</div>
            </div>
        </div>

        <div class="section" id="commissionSection" style="display: none;">
            <div class="section-title">
                üí∞ Commission Payment
            </div>
            <div id="commissionStatus">
                <div class="loading">Checking commission status...</div>
            </div>
        </div>

        <div class="claim-section" id="claimSection" style="display: none;">
            <div class="claim-amount" id="claimAmount">1000 CCOIN</div>
            <div class="claim-label">Ready to claim!</div>
            <button class="claim-btn" id="claimBtn" onclick="claimTokens()">
                Claim Airdrop
            </button>
        </div>
    </div>

    <script>
        let currentTelegramId = null;
        let walletConnected = false;
        let walletAddress = null;
        let commissionPaid = false;
        let tasksCompleted = false;
        let commissionPaymentInProgress = false;

        // Initialize Telegram WebApp
        if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
            
            const initData = window.Telegram.WebApp.initData;
            if (initData) {
                const urlParams = new URLSearchParams(initData);
                const userParam = urlParams.get('user');
                if (userParam) {
                    const userData = JSON.parse(decodeURIComponent(userParam));
                    currentTelegramId = userData.id.toString();
                }
            }
        }

        // Fallback to URL parameter
        if (!currentTelegramId) {
            const urlParams = new URLSearchParams(window.location.search);
            currentTelegramId = urlParams.get('telegram_id');
        }

        console.log('Current Telegram ID:', currentTelegramId);

        async function checkUserTasks() {
            if (!currentTelegramId) {
                console.log('No telegram_id for task check');
                return;
            }

            try {
                console.log('Checking user tasks...');
                
                const response = await fetch(`/usertasks/api/user-tasks?telegram_id=${currentTelegramId}`);
                const result = await response.json();
                
                console.log('User tasks response:', result);
                
                if (result.success) {
                    const tasksList = document.getElementById('tasksList');
                    const userTokensElement = document.getElementById('userTokens');
                    
                    userTokensElement.textContent = `${result.user_tokens} CCOIN`;
                    
                    if (result.tasks && result.tasks.length > 0) {
                        let completedTasks = 0;
                        let totalTasks = result.tasks.length;
                        
                        tasksList.innerHTML = result.tasks.map(task => {
                            if (task.completed) completedTasks++;
                            
                            return `
                                <div class="status-item ${task.completed ? 'completed' : 'pending'}">
                                    <span class="status-icon">${task.completed ? '‚úÖ' : '‚è≥'}</span>
                                    <div class="status-content">
                                        <div class="status-title">${task.name}</div>
                                        <div class="status-subtitle">${task.description}</div>
                                        ${task.completed ? `<div class="status-date">Completed ‚Ä¢ +${task.reward} CCOIN</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        const completionPercentage = Math.round((completedTasks / totalTasks) * 100);
                        document.getElementById('completionPercentage').textContent = `${completionPercentage}%`;
                        document.getElementById('progressFill').style.width = `${completionPercentage}%`;
                        
                        tasksCompleted = completedTasks === totalTasks;
                        
                    } else {
                        tasksList.innerHTML = `
                            <div class="status-item pending">
                                <span class="status-icon">üìã</span>
                                <div class="status-content">
                                    <div class="status-title">No Tasks Available</div>
                                    <div class="status-subtitle">Check back later for new tasks</div>
                                </div>
                            </div>
                        `;
                    }
                } else {
                    throw new Error(result.error || 'Failed to fetch tasks');
                }
                
            } catch (error) {
                console.error('Error checking tasks:', error);
                document.getElementById('tasksList').innerHTML = `
                    <div class="status-item failed">
                        <span class="status-icon">‚ùå</span>
                        <div class="status-content">
                            <div class="status-title">Error Loading Tasks</div>
                            <div class="status-subtitle">${error.message}</div>
                        </div>
                    </div>
                `;
            }
        }

        async function checkWalletStatus() {
            if (!currentTelegramId) {
                console.log('No telegram_id for wallet check');
                return;
            }
            
            try {
                console.log('Checking wallet status...');
                
                const response = await fetch(`/api/wallet/status?telegram_id=${currentTelegramId}`);
                const result = await response.json();
                
                console.log('Wallet status response:', result);
                
                if (result.success) {
                    const walletSection = document.getElementById('walletSection');
                    const walletStatus = document.getElementById('walletStatus');
                    
                    walletSection.style.display = 'block';
                    
                    if (result.connected) {
                        walletConnected = true;
                        walletAddress = result.address;
                        
                        const shortAddress = `${result.address.substring(0, 6)}...${result.address.substring(result.address.length - 4)}`;
                        
                        walletStatus.innerHTML = `
                            <div class="status-item completed">
                                <span class="status-icon">‚úÖ</span>
                                <div class="status-content">
                                    <div class="status-title">Wallet Connected</div>
                                    <div class="status-subtitle">Phantom wallet connected successfully</div>
                                    <div class="wallet-dropdown">
                                        <button class="wallet-button">
                                            ${shortAddress}
                                            <span class="dropdown-arrow">‚ñº</span>
                                        </button>
                                        <div class="wallet-content">
                                            <a href="#" onclick="copyAddress('${result.address}')">üìã Copy Address</a>
                                            <a href="#" onclick="disconnectWallet()">üîå Disconnect</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    } else {
                        walletConnected = false;
                        walletAddress = null;
                        
                        walletStatus.innerHTML = `
                            <div class="status-item pending">
                                <span class="status-icon">üí≥</span>
                                <div class="status-content">
                                    <div class="status-title">Connect Wallet</div>
                                    <div class="status-subtitle">Connect your Phantom wallet to participate</div>
                                    <button class="connect-wallet-btn" onclick="connectWallet()">
                                        Connect Phantom Wallet
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error checking wallet status:', error);
            }
        }

        async function checkCommissionStatus() {
            if (!currentTelegramId) {
                console.log('No telegram_id for commission check');
                return;
            }
            
            try {
                console.log('Checking commission status...');
                
                const response = await fetch(`/api/commission/status?telegram_id=${currentTelegramId}`);
                const result = await response.json();
                
                console.log('Commission status response:', result);
                
                if (result.success) {
                    const commissionSection = document.getElementById('commissionSection');
                    const commissionStatus = document.getElementById('commissionStatus');
                    
                    commissionSection.style.display = 'block';
                    
                    if (result.paid) {
                        commissionPaid = true;
                        commissionStatus.innerHTML = `
                            <div class="status-item completed">
                                <span class="status-icon">‚úÖ</span>
                                <div class="status-content">
                                    <div class="status-title">Commission Paid</div>
                                    <div class="status-subtitle">Payment completed successfully</div>
                                    ${result.payment_date ? `<div class="status-date">Paid: ${new Date(result.payment_date).toLocaleDateString()}</div>` : ''}
                                </div>
                            </div>
                        `;
                    } else {
                        commissionPaid = false;
                        commissionStatus.innerHTML = `
                            <div class="status-item pending">
                                <span class="status-icon">üí∞</span>
                                <div class="status-content">
                                    <div class="status-title">Commission Payment Required</div>
                                    <div class="status-subtitle">Pay 0.01 SOL to participate in airdrop</div>
                                    <button class="pay-commission-btn" id="payCommissionBtn" onclick="payCommission()">
                                        Pay Commission
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                }
                
            } catch (error) {
                console.error('Error checking commission status:', error);
            }
        }

        async function connectWallet() {
            try {
                console.log('Connecting wallet...');
                
                if (!currentTelegramId) {
                    throw new Error('No Telegram ID available');
                }
                
                const baseUrl = window.location.origin;
                const callbackUrl = `${baseUrl}/wallet/callback?telegram_id=${currentTelegramId}`;
                
                const phantomUrl = `https://phantom.app/ul/v1/connect?` +
                    `app_url=${encodeURIComponent(baseUrl)}&` +
                    `dapp_encryption_public_key=phantom&` +
                    `nonce=${currentTelegramId}&` +
                    `redirect_link=${encodeURIComponent(callbackUrl)}`;
                
                console.log('Opening Phantom URL:', phantomUrl);
                
                if (window.Telegram && window.Telegram.WebApp) {
                    window.Telegram.WebApp.openLink(phantomUrl);
                } else {
                    window.open(phantomUrl, '_blank');
                }
                
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert(`Connection Error: ${error.message}`);
            }
        }

        async function payCommission() {
            if (commissionPaymentInProgress) {
                console.log('Commission payment already in progress');
                return;
            }
            
            commissionPaymentInProgress = true;
            const button = document.getElementById('payCommissionBtn');
            const originalText = button.textContent;
            
            try {
                button.textContent = 'Processing...';
                button.disabled = true;
                
                console.log('Starting commission payment process...');
                
                // ÿßÿ®ÿ™ÿØÿß ÿ®ÿ±ÿ±ÿ≥€å ⁄©ŸÜ€åŸÖ wallet ŸÖÿ™ÿµŸÑ ÿßÿ≥ÿ™ €åÿß ŸÜŸá
                if (!walletConnected || !walletAddress) {
                    throw new Error('Please connect your wallet first');
                }
                
                // ÿØÿ±ÿÆŸàÿßÿ≥ÿ™ Ÿæÿ±ÿØÿßÿÆÿ™ ⁄©ŸÖ€åÿ≥€åŸàŸÜ
                const response = await fetch('/api/commission/pay', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: currentTelegramId,
                        wallet_address: walletAddress
                    })
                });
                
                const result = await response.json();
                console.log('Commission payment API response:', result);
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to initiate commission payment');
                }
                
                // ÿß€åÿ¨ÿßÿØ Solana Pay URL ÿ®ÿ±ÿß€å Phantom
                const baseUrl = window.location.origin;
                const callbackUrl = `${baseUrl}/commission/callback?telegram_id=${currentTelegramId}`;
                
                // ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ Phantom Deep Link ÿ®ÿß Ÿæÿßÿ±ÿßŸÖÿ™ÿ±Ÿáÿß€å ÿµÿ≠€åÿ≠
                const phantomUrl = `https://phantom.app/ul/v1/signAndSendTransaction?` +
                    `dapp_encryption_public_key=phantom&` +
                    `nonce=${currentTelegramId}&` +
                    `redirect_link=${encodeURIComponent(callbackUrl)}&` +
                    `recipient=${encodeURIComponent(result.recipient)}&` +
                    `amount=${result.amount}&` +
                    `payload=commission_payment`;
                
                console.log('Opening Phantom URL:', phantomUrl);
                
                // ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ URL ÿØÿ± Telegram WebApp
                if (window.Telegram && window.Telegram.WebApp) {
                    console.log('Opening Phantom in Telegram WebApp...');
                    window.Telegram.WebApp.openLink(phantomUrl);
                } else {
                    console.log('Not in Telegram WebApp, opening in new window...');
                    window.open(phantomUrl, '_blank');
                }
                
            } catch (error) {
                console.error('Error initiating commission payment:', error);
                alert(`Payment Error: ${error.message}`);
                
            } finally {
                commissionPaymentInProgress = false;
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        async function disconnectWallet() {
            try {
                const response = await fetch('/api/wallet/disconnect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        telegram_id: currentTelegramId
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    walletConnected = false;
                    walletAddress = null;
                    checkWalletStatus();
                } else {
                    alert(`Disconnect Error: ${result.error}`);
                }
                
            } catch (error) {
                console.error('Error disconnecting wallet:', error);
                alert(`Disconnect Error: ${error.message}`);
            }
        }

        function copyAddress(address) {
            navigator.clipboard.writeText(address).then(() => {
                alert('Address copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy address:', err);
            });
        }

        function checkWalletUpdateParam() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('wallet_updated') === '1') {
                console.log('Wallet was updated, refreshing status...');
                const newUrl = window.location.pathname + (urlParams.has('telegram_id') ? `?telegram_id=${urlParams.get('telegram_id')}` : '');
                window.history.replaceState({}, '', newUrl);
                
                setTimeout(() => {
                    checkWalletStatus();
                }, 500);
                
                return true;
            }
            return false;
        }

        function checkCommissionUpdateParam() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('commission_updated') === '1') {
                console.log('Commission was updated, refreshing status...');
                const newUrl = window.location.pathname + (urlParams.has('telegram_id') ? `?telegram_id=${urlParams.get('telegram_id')}` : '');
                window.history.replaceState({}, '', newUrl);
                
                setTimeout(() => {
                    checkCommissionStatus();
                }, 500);
                
                return true;
            }
            return false;
        }

        function updateClaimSection() {
            const claimSection = document.getElementById('claimSection');
            
            if (tasksCompleted && walletConnected && commissionPaid) {
                claimSection.style.display = 'block';
            } else {
                claimSection.style.display = 'none';
            }
        }

        async function claimTokens() {
            try {
                console.log('Claiming tokens...');
                
                if (!tasksCompleted || !walletConnected || !commissionPaid) {
                    alert('Please complete all requirements first');
                    return;
                }
                
                const button = document.getElementById('claimBtn');
                const originalText = button.textContent;
                
                button.textContent = 'Claiming...';
                button.disabled = true;
                
                // Simulate claim process
                setTimeout(() => {
                    button.textContent = 'Claimed!';
                    alert('Airdrop claimed successfully!');
                }, 2000);
                
            } catch (error) {
                console.error('Error claiming tokens:', error);
                alert(`Claim Error: ${error.message}`);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');
            
            const walletUpdated = checkWalletUpdateParam();
            const commissionUpdated = checkCommissionUpdateParam();
            
            if (!walletUpdated && !commissionUpdated) {
                checkUserTasks();
                checkWalletStatus();
                checkCommissionStatus();
            }
            
            setInterval(() => {
                updateClaimSection();
            }, 1000);
        });
    </script>
</body>
</html>
