<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<meta name="csrf-token" content="{{ request.session.csrf_token }}">
<title>Airdrop</title>
<link href="https://fonts.googleapis.com/css2?family=Urbanist:wght@400;600;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{{ url_for('static', path='css/airdrop.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>

<style>
/* Ø§Ø³ØªØ§ÛŒÙ„ Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ */
.wallet-dropdown {
position: relative;
display: inline-block;
width:100%;
}

.wallet-dropdown-content {
display: none;
position: absolute;
background-color:#1a1a1a;
min-width:100%;
box-shadow:0px 8px 16px 0px rgba(0,0,0,0.3);
z-index:9999;
border-radius:10px;
border:2px solid #333;
top:calc(100% + 2px);
left:0;
opacity:0;
transform:translateY(-10px);
transition: all 0.3s ease;
margin-top:0;
}

.wallet-dropdown-content.show {
display: block;
opacity:1;
transform:translateY(0);
}

.wallet-info-dropdown {
background:#1a1a1a;
padding:15px;
border-radius:8px;
text-align: left;
color:#fff;
}

.wallet-address-dropdown {
font-family: monospace;
font-size:11px;
word-break: break-all;
background:#2d2d2d;
padding:8px;
border-radius:5px;
margin:8px 0;
color:#fff;
border:1px solid #444;
max-height:60px;
overflow-y: auto;
}

.wallet-actions-dropdown {
display: flex;
gap:8px;
margin-top:10px;
}

.wallet-action-btn {
background:#333;
color: white;
border:1px solid #555;
padding:10px 15px;
border-radius:6px;
font-size:12px;
cursor: pointer;
flex:1;
text-align: center;
transition: all 0.3s ease;
font-weight:500;
}

.wallet-action-btn:hover {
background:#444;
transform:translateY(-1px);
}

.disconnect-btn {
background:#2d2d2d;
color:#ff4757;
border-color:#ff4757;
}

.disconnect-btn:hover {
background:#ff4757;
color:#fff;
}

.change-btn {
background:#2d2d2d;
color:#ffa502;
border-color:#ffa502;
}

.change-btn:hover {
background:#ffa502;
color:#000;
}

.phantom-modal-btn {
background: linear-gradient(135deg, #9945FF 0%, #14F195 100%);
color: white;
border: none;
padding: 15px 25px;
border-radius: 12px;
font-weight: 600;
font-size: 14px;
cursor: pointer;
transition: all 0.3s ease;
display: flex;
align-items: center;
gap: 10px;
justify-content: center;
width: 100%;
margin: 10px 0;
}

.phantom-modal-btn:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(153, 69, 255, 0.3);
}

.phantom-modal-btn.open-app {
background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
}

.phantom-modal-btn.open-app:hover {
box-shadow: 0 8px 25px rgba(76, 175, 80, 0.3);
}
</style>
</head>

<body>
<!-- Ù…Ø­ØªÙˆØ§ÛŒ HTML Ù‡Ù…Ø§Ù†â€ŒØ·ÙˆØ± Ú©Ù‡ Ø¯Ø± GitHub Ø´Ù…Ø§Ø³Øª -->
<div class="container">
<div class="box">
<div class="countdown">
<span id="days">00</span>d :
<span id="hours">00</span>h :
<span id="minutes">00</span>m :
<span id="seconds">00</span>s
</div>
<div class="token-value">
<p>1 CCoin = $ 0.02</p>
</div>
</div>

<div class="airdrop-criteria">
<h2>Airdrop Criteria</h2>

<div id="task-completion" class="task-box">
<button class="task-button" id="task-completion-btn">
<span class="left-text">Tasks Completion</span>
<i class="fas fa-chevron-right right-icon"></i>
</button>
</div>

<div id="inviting-friends" class="task-box">
<button class="task-button" id="inviting-friends-btn">
<span class="left-text">Inviting Friends</span>
<i class="fas fa-chevron-right right-icon"></i>
</button>
</div>

<div id="connect-wallet" class="task-box">
<div class="wallet-dropdown" id="wallet-dropdown">
<button class="task-button wallet-connect-button" id="wallet-connect-btn">
<span class="left-text" id="wallet-button-text">Connect Wallet</span>
<div class="wallet-status-indicator" id="wallet-status-indicator"></div>
<i class="fas fa-chevron-right right-icon" id="wallet-icon"></i>
</button>
<div id="wallet-dropdown-content" class="wallet-dropdown-content">
<div class="wallet-info-dropdown">
<div><strong>âœ… Connected Wallet:</strong></div>
<div id="wallet-address-dropdown" class="wallet-address-dropdown"></div>
<div class="wallet-actions-dropdown">
<button class="wallet-action-btn change-btn" id="change-wallet-btn">
ğŸ”„ Change
</button>
<button class="wallet-action-btn disconnect-btn" id="disconnect-wallet-btn">
ğŸš« Disconnect
</button>
</div>
</div>
</div>
</div>
</div>

<div id="pay-commission" class="task-box">
<button class="task-button" id="commission-button">
<span class="left-text" id="commission-button-text">Pay for the Commission</span>
<i class="fas fa-chevron-right right-icon" id="commission-icon"></i>
</button>
</div>

</div>

<div class="footer-icons">
<a href="/leaders" class="footer-btn">
<i class="fas fa-medal"></i>
<span>Leaders</span>
</a>
<a href="/friends" class="footer-btn">
<i class="fas fa-user-friends"></i>
<span>Friends</span>
</a>
<a href="/home" class="footer-btn">
<i class="fas fa-home"></i>
<span>Home</span>
</a>
<a href="/earn" class="footer-btn">
<i class="fas fa-coins"></i>
<span>Earn</span>
</a>
<a href="/airdrop" class="footer-btn active">
<i class="fas fa-rocket"></i>
<span>AirDrop</span>
</a>
</div>
</div>

<!-- Ú©Ø¯Ù‡Ø§ÛŒ JavaScript Ù…Ø³ØªÙ‚ÛŒÙ…Ø§Ù‹ Ø¯Ø± HTML -->
<script>
// Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ÙˆÙ„ÛŒÙ‡
const APP_CONFIG = {
    USER_ID: "{{ request.session.telegram_id }}",
    SOLANA_RPC_URL: "{{ config.SOLANA_RPC }}",
    COMMISSION_AMOUNT: {{ config.COMMISSION_AMOUNT if config.COMMISSION_AMOUNT else 0.1 }},
    ADMIN_WALLET: "{{ config.ADMIN_WALLET }}",
    INITIAL_TASKS_COMPLETED: {{ 'true' if tasks_completed else 'false' }},
    INITIAL_INVITED_FRIENDS: {{ 'true' if invited else 'false' }},
    INITIAL_WALLET_CONNECTED: {{ 'true' if wallet_connected else 'false' }},
    INITIAL_COMMISSION_PAID: {{ 'true' if commission_paid else 'false' }},
    INITIAL_WALLET_ADDRESS: "{{ user_wallet_address if user_wallet_address else '' }}"
};

let tasksCompleted = {
    task: APP_CONFIG.INITIAL_TASKS_COMPLETED,
    invite: APP_CONFIG.INITIAL_INVITED_FRIENDS,
    wallet: APP_CONFIG.INITIAL_WALLET_CONNECTED,
    pay: APP_CONFIG.INITIAL_COMMISSION_PAID
};

let connectedWallet = APP_CONFIG.INITIAL_WALLET_ADDRESS;
let phantomProvider = null;
let phantomDetected = false;

// ØªØ´Ø®ÛŒØµ Phantom
async function detectPhantomWallet() {
    console.log("ğŸ” Starting Phantom detection...");
    
    if (window.phantom?.solana?.isPhantom) {
        phantomDetected = true;
        return window.phantom.solana;
    }

    if (window.solana?.isPhantom) {
        phantomDetected = true;
        return window.solana;
    }

    for (let i = 0; i < 50; i++) {
        await new Promise(resolve => setTimeout(resolve, 100));
        
        if (window.phantom?.solana?.isPhantom) {
            phantomDetected = true;
            return window.phantom.solana;
        }
        
        if (window.solana?.isPhantom) {
            phantomDetected = true;
            return window.solana;
        }
    }

    phantomDetected = false;
    return null;
}

async function getPhantomProvider() {
    if (phantomProvider && phantomDetected) {
        return phantomProvider;
    }
    phantomProvider = await detectPhantomWallet();
    return phantomProvider;
}

// Toggle wallet dropdown - Ø§ØµÙ„Ø§Ø­ Ø´Ø¯Ù‡
async function toggleWalletDropdown() {
    console.log("ğŸ‘› Toggle wallet dropdown clicked");
    
    const dropdown = document.getElementById('wallet-dropdown-content');
    
    // Ø¨Ø±Ø±Ø³ÛŒ Phantom
    const provider = await getPhantomProvider();
    if (!provider) {
        console.log("âŒ Phantom not installed, showing install modal");
        showPhantomModal('install');
        return;
    }

    // Ø§Ú¯Ø± wallet Ù…ØªØµÙ„ Ø§Ø³Øª - Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ù…Ù†ÙˆÛŒ Ú©Ø´ÙˆÛŒÛŒ
    if (connectedWallet && tasksCompleted.wallet === true) {
        console.log("ğŸ“‹ Toggling dropdown menu for connected wallet");
        dropdown?.classList.toggle('show');
        return;
    }

    // Ø§Ú¯Ø± wallet Ù…ØªØµÙ„ Ù†ÛŒØ³Øª - Ù†Ù…Ø§ÛŒØ´ modal Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„
    console.log("ğŸ”— Wallet not connected, showing connect modal");
    dropdown?.classList.remove('show');
    showPhantomModal('connect');
}

// Ù†Ù…Ø§ÛŒØ´ modal
function showPhantomModal(type = 'install') {
    console.log(`ğŸ”„ Showing Phantom modal: ${type}`);
    
    const existingModal = document.getElementById('phantom-modal');
    if (existingModal) {
        existingModal.remove();
    }

    const modal = document.createElement('div');
    modal.id = 'phantom-modal';
    modal.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.8); display: flex; align-items: center;
        justify-content: center; z-index: 10000;
    `;

    let title, description, buttonText, buttonAction, buttonClass;

    if (type === 'install') {
        title = 'Phantom Wallet Required';
        description = 'To continue, you need to install Phantom wallet extension first.';
        buttonText = 'Install Phantom Wallet';
        buttonAction = 'installPhantom()';
        buttonClass = 'phantom-modal-btn';
    } else if (type === 'connect') {
        title = 'Connect Phantom Wallet';
        description = 'Phantom wallet detected! Click to connect your wallet.';
        buttonText = 'Open Phantom App';
        buttonAction = 'connectWalletFromModal()';
        buttonClass = 'phantom-modal-btn open-app';
    } else if (type === 'payment') {
        title = 'Pay Commission';
        description = `Click to open Phantom app and pay ${APP_CONFIG.COMMISSION_AMOUNT} SOL commission.`;
        buttonText = 'Open Phantom App';
        buttonAction = 'processCommissionPayment()';
        buttonClass = 'phantom-modal-btn open-app';
    }

    modal.innerHTML = `
        <div style="background: #1a1a1a; padding: 30px; border-radius: 15px; text-align: center; 
                    max-width: 350px; width: 90%; border: 2px solid #333;">
            <div style="font-size: 48px; margin-bottom: 20px;">ğŸ‘›</div>
            <h2 style="color: white; margin-bottom: 15px;">${title}</h2>
            <p style="color: #ccc; margin-bottom: 25px; line-height: 1.5;">${description}</p>
            <button class="${buttonClass}" onclick="${buttonAction}">${buttonText}</button>
            <button onclick="closePhantomModal()" style="background: transparent; color: #999; 
                   border: 1px solid #444; padding: 12px 20px; border-radius: 8px; cursor: pointer; 
                   width: 100%; margin-top: 10px;">Cancel</button>
        </div>
    `;

    document.body.appendChild(modal);
}

function closePhantomModal() {
    const modal = document.getElementById('phantom-modal');
    if (modal) modal.remove();
}

function installPhantom() {
    window.open('https://phantom.app/', '_blank');
    closePhantomModal();
}

async function connectWalletFromModal() {
    closePhantomModal();
    await connectWallet();
}

async function processCommissionPayment() {
    closePhantomModal();
    const provider = await getPhantomProvider();
    if (provider) {
        await processCommissionTransaction(provider);
    }
}

// Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù…ÛŒØ³ÛŒÙˆÙ†
async function payCommission() {
    console.log("ğŸ’° Pay commission clicked");

    if (tasksCompleted.pay === true) {
        showToast('Commission already paid!', 'info');
        return;
    }

    const provider = await getPhantomProvider();
    if (!provider) {
        console.log("âŒ Phantom not detected, showing install modal");
        showPhantomModal('install');
        return;
    }

    if (!connectedWallet || tasksCompleted.wallet !== true) {
        showToast('Please connect your wallet first!', 'error');
        showPhantomModal('connect');
        return;
    }

    console.log("ğŸ’³ Showing payment modal");
    showPhantomModal('payment');
}

// Ø¨Ù‚ÛŒÙ‡ ØªÙˆØ§Ø¨Ø¹ ...
async function connectWallet() {
    // Ú©Ø¯ Ø§ØªØµØ§Ù„ wallet
}

function updateWalletUI(address, connected) {
    // Ú©Ø¯ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
}

function showToast(message, type) {
    // Ú©Ø¯ Ù†Ù…Ø§ÛŒØ´ toast
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // ØªÙ†Ø¸ÛŒÙ… event listeners
    document.getElementById('wallet-connect-btn')?.addEventListener('click', toggleWalletDropdown);
    document.getElementById('commission-button')?.addEventListener('click', payCommission);
    document.getElementById('change-wallet-btn')?.addEventListener('click', changeWallet);
    document.getElementById('disconnect-wallet-btn')?.addEventListener('click', disconnectWallet);
    
    // Ø¨Ù‚ÛŒÙ‡ initialization
    initCountdown();
    updateTasksUI();
});

// Ø¨Ù‚ÛŒÙ‡ Ú©Ø¯Ù‡Ø§...
</script>

</body>
</html>
