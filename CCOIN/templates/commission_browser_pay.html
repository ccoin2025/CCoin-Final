<!-- templates/commission_browser_pay.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pay Commission - CCoin</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px 30px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            max-width: 500px;
            width: 100%;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .logo { font-size: 64px; margin-bottom: 20px; animation: pulse 2s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        h1 { margin-bottom: 10px; font-size: 28px; font-weight: 700; }
        .subtitle { font-size: 14px; opacity: 0.9; margin-bottom: 30px; }
        .info-box {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid rgba(33, 150, 243, 0.4);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }
        .info-box h3 {
            color: #ffd700;
            margin-bottom: 15px;
            text-align: center;
        }
        .info-box p { line-height: 1.6; margin-bottom: 10px; }
        .info-box ol { margin-left: 20px; margin-top: 10px; }
        .info-box li { margin: 8px 0; line-height: 1.5; }
        .commission-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 25px;
            border-radius: 16px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 255, 255, 0.15);
        }
        .amount {
            font-size: 42px;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
        }
        .fee-info {
            font-size: 13px;
            color: #90ee90;
            margin-top: 12px;
            padding: 8px;
            background: rgba(144, 238, 144, 0.1);
            border-radius: 8px;
        }
        .btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #000;
            border: none;
            padding: 16px 32px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s ease;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            text-decoration: none;
            display: inline-block;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5); }
        .btn:active { transform: translateY(-1px); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }
        .return-btn { background: rgba(255, 255, 255, 0.2); color: white; box-shadow: none; }
        .return-btn:hover { background: rgba(255, 255, 255, 0.3); box-shadow: 0 4px 15px rgba(255, 255, 255, 0.2); }
        .verify-btn {
            background: rgba(76, 175, 80, 0.3);
            color: white;
            margin-top: 5px;
            display: none;
        }
        .verify-btn:hover { background: rgba(76, 175, 80, 0.5); }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 12px;
            display: none;
            font-size: 14px;
            font-weight: 500;
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .status.success { background: rgba(76, 175, 80, 0.25); color: #4caf50; border: 1px solid rgba(76, 175, 80, 0.4); display: block; }
        .status.error { background: rgba(244, 67, 54, 0.25); color: #f44336; border: 1px solid rgba(244, 67, 54, 0.4); display: block; }
        .status.info { background: rgba(33, 150, 243, 0.25); color: #2196f3; border: 1px solid rgba(33, 150, 243, 0.4); display: block; }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #instructionsSection { display: block; }
        #phantomSection { display: none; }

        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 20px;
            font-size: 11px;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
        .debug-info.show { display: block; }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">üí∞</div>
    <h1>Commission Payment</h1>
    <p class="subtitle">Complete your payment to unlock the airdrop</p>

    <div class="commission-info">
      <div class="amount">{{ commission_amount }} SOL</div>
      <div class="fee-info">Network fees may apply</div>
    </div>

    <div id="status" class="status"></div>

    <div id="instructionsSection">
      <div class="info-box">
        <h3>üìã Payment Instructions</h3>
        <p>Please follow these steps carefully:</p>
        <ol>
          <li>Click "I Understand"</li>
          <li>Click "Pay with Phantom"</li>
          <li>Approve the transaction in Phantom</li>
          <li>Wait for auto verification</li>
        </ol>
      </div>

      <button class="btn" onclick="showPhantomButton()">‚úÖ I Understand</button>
    </div>

    <div id="phantomSection" style="display:none">
      <button class="btn" id="pay-btn-mobile" onclick="handlePaymentDeeplink()">
        <span id="btn-text-mobile">üì± Pay with Phantom (Mobile)</span>
      </button>
      
      <button class="btn" id="pay-btn-desktop" onclick="handlePaymentProvider()">
        <span id="btn-text-desktop">üåê Pay with Phantom (Browser)</span>
      </button>
      
      <button class="btn verify-btn" id="verify-btn" onclick="checkPayment()" style="display:none">‚úÖ Check Payment Status</button>
    </div>

    <a href="https://t.me/{{ bot_username }}" class="btn return-btn">‚Üê Return to Bot</a>

    <div id="debug-info" class="debug-info"></div>
  </div>

<script>
const CONFIG = {
  telegramId: '{{ telegram_id }}',
  botUsername: '{{ bot_username }}',
  commissionAmount: {{ commission_amount }},
  adminWallet: '{{ admin_wallet }}'
};

let tg = window.Telegram?.WebApp;
if (tg) {
  tg.ready();
  tg.expand();
}

// Debug logging
function debugLog(message, data = null) {
  const debugEl = document.getElementById('debug-info');
  const timestamp = new Date().toLocaleTimeString();
  let logMsg = `[${timestamp}] ${message}`;
  if (data) {
    logMsg += '\n' + JSON.stringify(data, null, 2);
  }
  debugEl.textContent += logMsg + '\n\n';
  debugEl.classList.add('show');
  console.log(message, data);
}

function showPhantomButton() {
  document.getElementById('instructionsSection').style.display = 'none';
  document.getElementById('phantomSection').style.display = 'block';
}

function showStatus(msg, type='info') {
  const el = document.getElementById('status');
  el.innerHTML = msg;
  el.className = `status ${type}`;
  el.style.display = 'block';
}

function setButtonLoading(buttonId, state, textId) {
  const btn = document.getElementById(buttonId);
  const btnText = document.getElementById(textId);
  const verifyBtn = document.getElementById('verify-btn');
  if (state) {
    btn.disabled = true;
    btnText.innerHTML = '<span class="spinner"></span> Processing...';
  } else {
    btn.disabled = false;
    verifyBtn.style.display = 'block';
  }
}

// ============================================
// ÿ±Ÿàÿ¥ 1: ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ Phantom Deeplink (ŸÖŸàÿ®ÿß€åŸÑ)
// ============================================
async function handlePaymentDeeplink(){
  try {
    setButtonLoading('pay-btn-mobile', true, 'btn-text-mobile');
    showStatus('üîÑ Preparing transaction...', 'info');
    debugLog('Starting payment process (Deeplink)');

    const create = await fetch("/commission/create_payment_session", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        telegram_id: CONFIG.telegramId,
        amount: CONFIG.commissionAmount,
        recipient: CONFIG.adminWallet
      })
    });

    const data = await create.json();
    debugLog('Server response:', data);

    if (!data.success) {
      throw new Error(data.error || 'Failed to create transaction');
    }

    const transaction = data.transaction;
    const sessionId = data.session_id;

    if (!transaction || !sessionId) {
      throw new Error('Invalid server response: missing transaction or session_id');
    }

    // ‚úÖ ÿ≥ÿßÿÆÿ™ callback URL
    const baseUrl = window.location.origin;
    const redirectUrl = `${baseUrl}/commission/phantom_callback?session=${sessionId}&telegram_id=${CONFIG.telegramId}`;
    
    debugLog('Transaction length:', transaction.length);
    debugLog('Redirect URL:', redirectUrl);

    // ‚úÖ ÿ≥ÿßÿÆÿ™ Phantom Deeplink ÿ®ÿß URLSearchParams
    const params = new URLSearchParams();
    params.append('dapp_encryption_public_key', 'AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=');
    params.append('nonce', sessionId.substring(0, 24));
    params.append('redirect_link', redirectUrl);
    params.append('payload', transaction);

    const deeplink = `https://phantom.app/ul/v1/signAndSendTransaction?${params.toString()}`;
    
    debugLog('Deeplink created, length:', deeplink.length);

    showStatus('üì± Opening Phantom Wallet...', 'info');

    // ‚úÖ ÿ®ÿßÿ≤ ⁄©ÿ±ÿØŸÜ Phantom
    setTimeout(() => {
      if (tg && tg.openLink) {
        debugLog('Opening via Telegram WebApp');
        tg.openLink(deeplink, { try_instant_view: false });
      } else {
        debugLog('Opening via window.location');
        window.location.href = deeplink;
      }
    }, 100);

    // ŸÜŸÖÿß€åÿ¥ ÿØ⁄©ŸÖŸá verify
    setTimeout(() => {
      setButtonLoading('pay-btn-mobile', false, 'btn-text-mobile');
      document.getElementById('btn-text-mobile').innerHTML = 'üì± Pay with Phantom (Mobile)';
      document.getElementById('verify-btn').style.display = 'block';
      showStatus('üí° After approving in Phantom, the page will reload. You can also click "Check Payment Status".', 'info');
    }, 3000);

  } catch (err) {
    console.error('Payment error:', err);
    debugLog('ERROR:', { message: err.message, stack: err.stack });
    showStatus('‚ùå ' + (err.message || 'Payment initialization failed'), 'error');
    setButtonLoading('pay-btn-mobile', false, 'btn-text-mobile');
    document.getElementById('btn-text-mobile').innerHTML = 'üì± Pay with Phantom (Mobile)';
  }
}

// ============================================
// ÿ±Ÿàÿ¥ 2: ÿßÿ≥ÿ™ŸÅÿßÿØŸá ÿßÿ≤ Phantom Provider API (ÿØÿ≥⁄©ÿ™ÿßŸæ)
// ============================================
async function handlePaymentProvider() {
  try {
    // ÿ®ÿ±ÿ±ÿ≥€å Ÿàÿ¨ŸàÿØ Phantom
    const phantom = window.solana;
    
    if (!phantom || !phantom.isPhantom) {
      showStatus('‚ùå Phantom wallet not detected! Please install Phantom extension or use Mobile option.', 'error');
      debugLog('Phantom not found');
      return;
    }

    setButtonLoading('pay-btn-desktop', true, 'btn-text-desktop');
    showStatus('üîÑ Connecting to Phantom...', 'info');
    debugLog('Starting payment process (Provider API)');

    // ÿßÿ™ÿµÿßŸÑ ÿ®Ÿá wallet
    const resp = await phantom.connect();
    const publicKey = resp.publicKey.toString();
    
    debugLog('Connected to Phantom:', publicKey);
    showStatus('üîÑ Preparing transaction...', 'info');

    // ÿØÿ±€åÿßŸÅÿ™ transaction ÿßÿ≤ ÿ≥ÿ±Ÿàÿ±
    const create = await fetch("/commission/create_payment_session", {
      method: "POST",
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ 
        telegram_id: CONFIG.telegramId,
        amount: CONFIG.commissionAmount,
        recipient: CONFIG.adminWallet
      })
    });

    const data = await create.json();
    debugLog('Server response:', data);

    if (!data.success) {
      throw new Error(data.error || 'Failed to create transaction');
    }

    // ‚úÖ Decode transaction ÿßÿ≤ base64
    const txBuffer = Uint8Array.from(atob(data.transaction), c => c.charCodeAt(0));
    debugLog('Transaction decoded, length:', txBuffer.length);
    
    showStatus('üìù Please approve the transaction in Phantom...', 'info');

    // ‚úÖ ÿßÿ±ÿ≥ÿßŸÑ ÿ™ÿ±ÿß⁄©ŸÜÿ¥
    const { signature } = await phantom.signAndSendTransaction({
      message: txBuffer
    });

    debugLog('Transaction sent, signature:', signature);
    showStatus('üîç Verifying transaction on blockchain...', 'info');

    // ‚úÖ Verify ⁄©ÿ±ÿØŸÜ
    const verify = await fetch('/commission/verify_signature', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        telegram_id: CONFIG.telegramId,
        session_id: data.session_id,
        signature: signature
      })
    });

    const result = await verify.json();
    debugLog('Verification result:', result);

    if (result.verified) {
      showStatus('‚úÖ Payment verified successfully! Redirecting...', 'success');
      setTimeout(() => {
        window.location.href = `/commission/success?telegram_id=${CONFIG.telegramId}`;
      }, 2000);
    } else {
      throw new Error(result.message || 'Verification failed');
    }

  } catch (err) {
    console.error('Payment error:', err);
    debugLog('ERROR:', { message: err.message, name: err.name });
    showStatus('‚ùå ' + (err.message || 'Payment failed'), 'error');
    setButtonLoading('pay-btn-desktop', false, 'btn-text-desktop');
    document.getElementById('btn-text-desktop').innerHTML = 'üåê Pay with Phantom (Browser)';
  }
}

// ============================================
// ÿ®ÿ±ÿ±ÿ≥€å ÿØÿ≥ÿ™€å Ÿàÿ∂ÿπ€åÿ™ Ÿæÿ±ÿØÿßÿÆÿ™
// ============================================
async function checkPayment(){
  try {
    showStatus('üîç Checking payment status...', 'info');
    debugLog('Manual payment check started');

    const resp = await fetch(`/commission/check_status?telegram_id=${CONFIG.telegramId}`);
    const data = await resp.json();

    debugLog('Payment status:', data);

    if (data.commission_paid) {
      showStatus('‚úÖ Payment confirmed! Redirecting...', 'success');
      setTimeout(() => {
        window.location.href = `/commission/success?telegram_id=${CONFIG.telegramId}`;
      }, 1500);
    } else {
      showStatus('‚è≥ Payment not confirmed yet. Please wait a few seconds and try again.', 'info');
    }
  } catch (e) {
    console.error('Check payment error:', e);
    debugLog('Check payment ERROR:', e.message);
    showStatus('‚ùå Failed to check payment status', 'error');
  }
}

// ============================================
// ŸÖÿØ€åÿ±€åÿ™ ÿÆŸàÿØ⁄©ÿßÿ± callback ÿßÿ≤ Phantom
// ============================================
window.addEventListener('load', async () => {
  const params = new URLSearchParams(window.location.search);

  debugLog('Page loaded with params:', Object.fromEntries(params));

  // ÿ®ÿ±ÿ±ÿ≥€å ÿÆÿ∑ÿßŸáÿß€å Phantom
  if (params.has('errorCode') || params.has('errorMessage')) {
    const errorCode = params.get('errorCode');
    const errorMessage = params.get('errorMessage') || 'Unknown error';
    debugLog('Phantom returned error:', { errorCode, errorMessage });
    showStatus(`‚ùå Phantom Error: ${decodeURIComponent(errorMessage)} (Code: ${errorCode})`, 'error');
    
    // ŸÜŸÖÿß€åÿ¥ ÿØ⁄©ŸÖŸá verify ÿØÿ± ÿµŸàÿ±ÿ™ ÿÆÿ∑ÿß
    document.getElementById('phantomSection').style.display = 'block';
    document.getElementById('instructionsSection').style.display = 'none';
    document.getElementById('verify-btn').style.display = 'block';
    return;
  }

  // ÿ®ÿ±ÿ±ÿ≥€å ŸÖŸàŸÅŸÇ€åÿ™ ÿ™ÿ±ÿß⁄©ŸÜÿ¥
  if (params.has('signature') && params.has('session')) {
    const signature = params.get('signature');
    const session = params.get('session');

    debugLog('Transaction signature received:', signature);
    showStatus('üîç Verifying transaction on blockchain...', 'info');

    try {
      const verify = await fetch('/commission/verify_signature', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({
          telegram_id: CONFIG.telegramId,
          session_id: session,
          signature: signature
        })
      });

      const result = await verify.json();
      debugLog('Verification result:', result);

      if (result.verified) {
        showStatus('‚úÖ Payment Verified Successfully! Redirecting...', 'success');
        setTimeout(() => {
          window.location.href = `/commission/success?telegram_id=${CONFIG.telegramId}`;
        }, 2000);
      } else {
        showStatus(`‚ö†Ô∏è ${result.message || 'Verification failed. Click "Check Payment Status" to retry.'}`, 'error');
        document.getElementById('phantomSection').style.display = 'block';
        document.getElementById('instructionsSection').style.display = 'none';
        document.getElementById('verify-btn').style.display = 'block';
      }
    } catch (e) {
      console.error('Verification error:', e);
      debugLog('Verification ERROR:', e.message);
      showStatus('‚ùå Failed to verify transaction. Click "Check Payment Status" to retry.', 'error');
      document.getElementById('phantomSection').style.display = 'block';
      document.getElementById('instructionsSection').style.display = 'none';
      document.getElementById('verify-btn').style.display = 'block';
    }
  }
});

// ============================================
// Auto-check Ÿáÿ± 5 ÿ´ÿßŸÜ€åŸá
// ============================================
let autoCheckInterval = null;
const verifyBtn = document.getElementById('verify-btn');
const observer = new MutationObserver((mutations) => {
  mutations.forEach((mutation) => {
    if (mutation.attributeName === 'style') {
      if (verifyBtn.style.display !== 'none' && !autoCheckInterval) {
        debugLog('Starting auto-check interval');
        autoCheckInterval = setInterval(async () => {
          try {
            const resp = await fetch(`/commission/check_status?telegram_id=${CONFIG.telegramId}`);
            const data = await resp.json();
            if (data.commission_paid) {
              clearInterval(autoCheckInterval);
              showStatus('‚úÖ Payment confirmed! Redirecting...', 'success');
              setTimeout(() => {
                window.location.href = `/commission/success?telegram_id=${CONFIG.telegramId}`;
              }, 1500);
            }
          } catch (e) {
            console.error('Auto-check error:', e);
          }
        }, 5000);
      } else if (verifyBtn.style.display === 'none' && autoCheckInterval) {
        clearInterval(autoCheckInterval);
        autoCheckInterval = null;
      }
    }
  });
});

observer.observe(verifyBtn, { attributes: true });

debugLog('Page initialized', {
  telegram_id: CONFIG.telegramId,
  has_telegram_webapp: !!tg,
  has_phantom: !!(window.solana && window.solana.isPhantom)
});
</script>
</body>
</html>
