<!DOCTYPE html>
<html lang="fa" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù…ÛŒØ³ÛŒÙˆÙ† â€” CCOIN (Mobile)</title>
  <meta name="description" content="Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù…ÛŒØ³ÛŒÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø§ÛŒØ±Ø¯Ø±Ø§Ù¾ â€” Mobile" />
  <link rel="manifest" href="/static/manifest.json">
  <link rel="icon" href="/static/images/icon-192x192.png">
  <style>
    /* MOBILE-FIRST STYLES (compact & readable) */
    :root{
      --bg1: linear-gradient(180deg,#0f1724 0%,#071024 100%);
      --card: rgba(255,255,255,0.04);
      --accent: #ffd700;
      --muted: rgba(255,255,255,0.6);
      --success: #4caf50;
      --danger: #f44336;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    html,body{height:100%}
    body{
      margin:0;
      padding:20px;
      background:var(--bg1);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      min-height:100vh;
    }
    .wrap{
      width:100%;
      max-width:460px;
      border-radius:18px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.03);
    }
    .logo{font-size:44px;text-align:center;margin-bottom:8px}
    h1{font-size:20px;margin:6px 0;text-align:center}
    p.lead{text-align:center;color:var(--muted);font-size:13px;margin:6px 0 14px}
    .card{
      background:var(--card);
      border-radius:12px;
      padding:14px;
      margin-bottom:14px;
      border:1px solid rgba(255,255,255,0.03);
    }
    .amount{
      font-weight:700;font-size:28px;color:var(--accent);text-align:center;margin-bottom:6px;
    }
    .small{font-size:12px;color:var(--muted);text-align:center}
    .btn{
      display:block;
      width:100%;
      border-radius:999px;
      padding:12px 14px;
      font-weight:700;
      font-size:15px;
      border:none;
      background:linear-gradient(90deg,var(--accent),#ffd54a);
      color:#000;
      text-align:center;
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
      margin-top:10px;
    }
    .btn.secondary{
      background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;
      box-shadow:none;margin-top:8px;
    }
    .status{
      margin-top:12px;padding:10px;border-radius:10px;font-size:13px;text-align:center;display:none;
    }
    .status.info{background:rgba(33,150,243,0.08);color:#90caf9;border:1px solid rgba(33,150,243,0.06)}
    .status.success{background:rgba(76,175,80,0.08);color:var(--success);border:1px solid rgba(76,175,80,0.06)}
    .status.error{background:rgba(244,67,54,0.06);color:var(--danger);border:1px solid rgba(244,67,54,0.06)}
    .hint{font-size:12px;color:var(--muted);margin-top:8px;text-align:center}
    .row{display:flex;gap:8px}
    .store-links{display:flex;gap:6px;justify-content:center;margin-top:8px}
    .store-links a{font-size:12px;color:var(--muted);text-decoration:none}
    /* ensure large tap targets on old phones */
    button, a.btn{min-height:48px}
    /* small screens */
    @media (max-width:360px){
      .amount{font-size:24px}
      h1{font-size:18px}
    }
  </style>
</head>
<body>
  <div class="wrap" role="main" aria-labelledby="title">
    <div class="logo">ğŸ’°</div>
    <h1 id="title">Ù¾Ø±Ø¯Ø§Ø®Øª Ú©Ù…ÛŒØ³ÛŒÙˆÙ† â€” CCOIN</h1>
    <p class="lead">Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ø·Ø±ÛŒÙ‚ Ú©ÛŒÙ Ù…ÙˆØ¨Ø§ÛŒÙ„ (Phantom ÛŒØ§ Ù‡Ø± Ú©ÛŒÙ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Solana Pay). ÙÙ‚Ø· Ù…ÙˆØ¨Ø§ÛŒÙ„ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</p>

    <div class="card">
      <div class="amount" id="amountDisplay">â€” SOL</div>
      <div class="small" id="feeNote">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø´Ø¨Ú©Ù‡ Ù…Ù…Ú©Ù† Ø§Ø³Øª Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯</div>
    </div>

    <div id="controls">
      <button id="payBtn" class="btn">Ù¾Ø±Ø¯Ø§Ø®Øª Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ú©ÛŒÙ</button>
      <button id="checkBtn" class="btn secondary" style="display:none">Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª</button>
      <div id="status" class="status info" role="status">Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª</div>

      <div class="hint" id="hint">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ø¯Ú©Ù…Ù‡ Â«Ù¾Ø±Ø¯Ø§Ø®ØªÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ â€” Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§Ø²Ú¯Ø±Ø¯ÛŒØ¯ ÛŒØ§ Ø±ÙˆÛŒ Â«Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®ØªÂ» Ø¨Ø²Ù†ÛŒØ¯.</div>

      <div class="store-links" id="storeLinks" style="display:none">
        <a id="phantomStore" target="_blank" rel="noopener">Ù†ØµØ¨ Phantom</a>
        <a id="otherWallets" target="_blank" rel="noopener">Ú©ÛŒÙ/Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯ÛŒÚ¯Ø±</a>
      </div>
    </div>

  </div>

<script>
/*
  Mobile-only Solana Pay flow (frontend)
  Assumptions:
  - Server endpoints:
    POST /commission/create_session
      body: { amount, telegram_id }
      returns: { paymentUrl, reference }  // reference = base58 string (publicKey)
    POST /commission/verify
      body: { reference, signature? }
      returns: { success: bool, payment_found: bool, signature?: string, details?: {} }

  - The server when creating session:
    * generates a unique reference publicKey (eg solana_web3.Keypair().publicKey.toBase58())
    * constructs a Solana Pay URL:
      solana:<RECIPIENT>?amount=<AMOUNT>&reference=<REFERENCE>&label=<LABEL>&message=<MSG>&redirect_url=<CALLBACK_URL>
    * returns that URL.

  - Verification should be reference-based: server searches transactions containing that reference key in instructions or memo.

  - Replace template tokens in server render: telegram_id, amount, bot_username, create_session_url, verify_url
*/

const CONFIG = {
  telegramId: '{{ telegram_id }}',
  amount: parseFloat('{{ commission_amount }}') || null,
  botUsername: '{{ bot_username }}',
  createSessionUrl: '/commission/create_session',
  verifyUrl: '/commission/verify',
  // play store / app store links (fallback)
  phantomIOS: 'https://apps.apple.com/app/phantom-solana-wallet/id1567076344',
  phantomAndroid: 'https://play.google.com/store/apps/details?id=com.phantom',
  // optional friendly label/message
  label: 'CCoin Commission',
  message: 'Airdrop commission for C-Coin miniapp'
};

// MOBILE DETECTION (very permissive)
const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(navigator.userAgent || navigator.vendor || window.opera);

const amountDisplay = document.getElementById('amountDisplay');
const payBtn = document.getElementById('payBtn');
const checkBtn = document.getElementById('checkBtn');
const statusEl = document.getElementById('status');
const hintEl = document.getElementById('hint');
const storeLinks = document.getElementById('storeLinks');
const phantomStore = document.getElementById('phantomStore');
const otherWallets = document.getElementById('otherWallets');

function showStatus(msg, type='info') {
  statusEl.textContent = msg;
  statusEl.className = `status ${type}`;
  statusEl.style.display = 'block';
}

function hideStatus() {
  statusEl.style.display = 'none';
}

function enableCheckButton(show=true) {
  if (show) {
    checkBtn.style.display = 'block';
  } else {
    checkBtn.style.display = 'none';
  }
}

// Populate amount
if (CONFIG.amount) {
  amountDisplay.textContent = CONFIG.amount + ' SOL';
} else {
  amountDisplay.textContent = 'â€” SOL';
  // still allow; createSession should validate
}

// On load: handle return from wallet
window.addEventListener('load', async () => {
  // If the URL has tx / transaction / signature param (wallet redirect)
  const params = new URLSearchParams(window.location.search);
  const tx = params.get('tx') || params.get('transaction') || params.get('signature') || params.get('transactionSignature');

  // If there is a reference param on URL (some wallets include), capture it
  const referenceFromURL = params.get('reference') || params.get('ref');

  if (tx || referenceFromURL) {
    showStatus('ğŸ” Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ±Ø§Ú©Ù†Ø´... Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø±ÙˆÛŒ Ø³Ø±ÙˆØ±', 'info');
    // attempt to verify on server (prefer signature if available)
    const payload = {
      telegram_id: CONFIG.telegramId,
      signature: tx || undefined,
      reference: referenceFromURL || undefined
    };
    try {
      const resp = await fetch(CONFIG.verifyUrl, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await resp.json();
      if (data && data.success && data.payment_found) {
        showStatus('âœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯ â€” Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø¯Ø§Ù…Ù‡', 'success');
        enableCheckButton(false);
        // redirect to success route after short delay
        setTimeout(() => {
          window.location.href = `/commission/success?telegram_id=${encodeURIComponent(CONFIG.telegramId)}`;
        }, 1200);
        return;
      } else {
        showStatus('âš ï¸ ØªØ±Ø§Ú©Ù†Ø´ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ Ù‡Ù†ÙˆØ² Ø¨Ø³ØªÙ‡ Ù†Ø´Ø¯Ù‡ â€” Ù„Ø·ÙØ§Ù‹ Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ Ùˆ Ø³Ù¾Ø³ Â«Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®ØªÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.', 'error');
        enableCheckButton(true);
      }
    } catch (e) {
      console.error('verify error', e);
      showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±. Ø§ØªØµØ§Ù„ Ø§ÛŒÙ†ØªØ±Ù†Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'error');
      enableCheckButton(true);
    }
    return;
  }

  // If page previously initiated payment, show check
  if (localStorage.getItem('ccoin_payment_session')) {
    showStatus('â³ Ù¾Ø±Ø¯Ø§Ø®Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± â€” Ø±ÙˆÛŒ Â«Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ù¾Ø±Ø¯Ø§Ø®ØªÂ» Ø¨Ø²Ù†ÛŒØ¯ ÛŒØ§ ØªØ§ Ø²Ù…Ø§Ù† Ø¨Ø±Ú¯Ø´Øª Ú©ÛŒÙ ØµØ¨Ø± Ú©Ù†ÛŒØ¯.', 'info');
    enableCheckButton(true);
  } else {
    showStatus('Ø¢Ù…Ø§Ø¯Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª â€” Ø¯Ú©Ù…Ù‡ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯', 'info');
    enableCheckButton(false);
  }

  // show store links if on mobile and no wallet detected
  if (isMobile) {
    phantomStore.href = CONFIG.phantomIOS; // we'll change by platform below
    otherWallets.href = 'https://solanapay.com/'; // generic info
    storeLinks.style.display = 'flex';
    if (/Android/i.test(navigator.userAgent)) {
      phantomStore.href = CONFIG.phantomAndroid;
      phantomStore.textContent = 'Phantom (Play Store)';
    } else {
      phantomStore.href = CONFIG.phantomIOS;
      phantomStore.textContent = 'Phantom (App Store)';
    }
    otherWallets.textContent = 'Ø¯Ø±Ø¨Ø§Ø±Ù‡ Solana Pay';
  } else {
    // Not mobile â€” show message
    showStatus('Ø§ÛŒÙ† ØµÙØ­Ù‡ ØµØ±ÙØ§Ù‹ Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡ â€” Ù„Ø·ÙØ§Ù‹ Ø§Ø² Ú¯ÙˆØ´ÛŒ Ù‡Ù…Ø±Ø§Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.', 'error');
    payBtn.disabled = true;
  }
});

// Create payment session on server and redirect
async function startPayment() {
  if (!isMobile) {
    showStatus('Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡.', 'error');
    return;
  }
  showStatus('â³ Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª...', 'info');
  payBtn.disabled = true;

  try {
    const resp = await fetch(CONFIG.createSessionUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        amount: CONFIG.amount,
        telegram_id: CONFIG.telegramId,
        label: CONFIG.label,
        message: CONFIG.message,
        return_url: window.location.href // ask server to set redirect_url to this page or a callback endpoint
      })
    });
    const data = await resp.json();
    if (!data || !data.paymentUrl || !data.reference) {
      throw new Error('Ù¾Ø§Ø³Ø® Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø² Ø³Ø±ÙˆØ±');
    }

    // Save session info locally so we can show check button after redirect if wallet doesn't callback
    localStorage.setItem('ccoin_payment_session', JSON.stringify({
      reference: data.reference,
      created_at: Date.now()
    }));

    showStatus('ğŸš€ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ú©ÛŒÙ â€” Ù¾Ø³ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ù‡ Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø§Ø²Ú¯Ø±Ø¯ÛŒØ¯.', 'info');
    enableCheckButton(true);

    // Try to open the payment URL (solana: or https link) â€” mobile wallets should handle it.
    // Use window.location to open; for better compatibility, try location.assign then fallback.
    // Some wallets expect a universal link (https), some accept solana: scheme.
    // Server should prefer returning a universal https link (preferred) or solana: URL.

    // attempt direct redirect
    window.location.href = data.paymentUrl;

    // As fallback: if it doesn't open (after timeout), show instructions to install Phantom.
    setTimeout(() => {
      showStatus('âš ï¸ Ø§Ú¯Ø± Ú©ÛŒÙ Ø¨Ø§Ø² Ù†Ø´Ø¯ØŒ Ø¢Ù† Ø±Ø§ Ù†ØµØ¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯. Ù„ÛŒÙ†Ú© Ù†ØµØ¨ Ø¯Ø± Ù¾Ø§ÛŒÛŒÙ† Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª.', 'error');
      payBtn.disabled = false;
    }, 2500);

  } catch (err) {
    console.error('startPayment error', err);
    showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª: ' + (err.message || err), 'error');
    payBtn.disabled = false;
    enableCheckButton(true);
  }
}

// Manual check payment (by reference)
async function checkPayment() {
  const sessionRaw = localStorage.getItem('ccoin_payment_session');
  if (!sessionRaw) {
    showStatus('Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªØ¸Ø§Ø± Ù†ÛŒØ³Øª. Ø§Ø¨ØªØ¯Ø§ Ù¾Ø±Ø¯Ø§Ø®Øª Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.', 'error');
    return;
  }
  const session = JSON.parse(sessionRaw);
  showStatus('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø±ÙˆÛŒ Ø´Ø¨Ú©Ù‡...', 'info');
  checkBtn.disabled = true;

  try {
    const resp = await fetch(CONFIG.verifyUrl, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        telegram_id: CONFIG.telegramId,
        reference: session.reference
      })
    });
    const data = await resp.json();
    if (data && data.success && data.payment_found) {
      showStatus('âœ… Ù¾Ø±Ø¯Ø§Ø®Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯ â€” Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø±Ø¨Ø§Øª...', 'success');
      localStorage.removeItem('ccoin_payment_session');
      setTimeout(() => {
        window.location.href = `/commission/success?telegram_id=${encodeURIComponent(CONFIG.telegramId)}`;
      }, 1000);
    } else {
      showStatus('âŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù‡Ù†ÙˆØ² ÛŒØ§ÙØª Ù†Ø´Ø¯ â€” Ú†Ù†Ø¯ Ù„Ø­Ø¸Ù‡ Ø¯ÛŒÚ¯Ø± ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'error');
      checkBtn.disabled = false;
    }
  } catch (err) {
    console.error('checkPayment error', err);
    showStatus('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª. Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø³Ø±ÙˆØ± Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯.', 'error');
    checkBtn.disabled = false;
  }
}

// Event bindings
payBtn.addEventListener('click', startPayment);
checkBtn.addEventListener('click', checkPayment);

// Accessibility: allow retry after 10 minutes if stuck
setInterval(() => {
  const sessionRaw = localStorage.getItem('ccoin_payment_session');
  if (!sessionRaw) return;
  const session = JSON.parse(sessionRaw);
  const age = Date.now() - session.created_at;
  // if older than 10 minutes, clear
  if (age > 10 * 60 * 1000) {
    localStorage.removeItem('ccoin_payment_session');
    showStatus('Ù†Ø´Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯ØŒ Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.', 'info');
    payBtn.disabled = false;
    checkBtn.disabled = false;
    enableCheckButton(false);
  }
}, 30 * 1000);
</script>
</body>
</html>
