<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pay Commission</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- کتابخانه bs58 برای ساخت reference -->
  <script src="https://unpkg.com/bs58@5.0.0/index.js"></script>
</head>
<body>
  <h2>Commission Payment</h2>
  <button id="payButton">Pay Commission</button>

  <script>
    // تولید reference به صورت base58-encoded 32-byte
    function generateReference() {
      const array = new Uint8Array(32);
      crypto.getRandomValues(array);
      return bs58.encode(array);
    }

    async function startPayment() {
      const adminWallet = '{{ admin_wallet }}';
      const amount = 0.01; 
      const memo = "commission-payment";

      // تولید reference معتبر
      const reference = generateReference();
      console.log("Generated reference (base58):", reference);

      // ذخیره reference برای چک‌کردن در سرور
      sessionStorage.setItem("commission_reference", reference);

      // ساخت Solana Pay URL
      const solanaPayUrl =
        `solana:${recipient}?amount=${amount}&reference=${reference}&memo=${encodeURIComponent(memo)}`;
      console.log("Solana Pay URL:", solanaPayUrl);

      // ریدایرکت کاربر به کیف پول
      window.location.href = solanaPayUrl;

      // شروع polling برای بررسی پرداخت
      checkPayment(reference);
    }

    // تابع polling برای بررسی تراکنش
    async function checkPayment(reference) {
      const telegramId = '{{ telegram_id }}';

      const interval = setInterval(async () => {
        try {
          const res = await fetch(
            `/commission/check_payment?telegram_id=${telegramId}&reference=${reference}`
          );
          const data = await res.json();

          if (data && data.status === "confirmed") {
            clearInterval(interval);
            alert("پرداخت تایید شد ✅");
            // می‌تونی کاربر رو هدایت کنی به صفحه success
            window.location.href = "/commission_success";
          }
        } catch (err) {
          console.error("Error checking payment:", err);
        }
      }, 5000); // هر 5 ثانیه چک کن
    }

    // کلیک روی دکمه پرداخت
    document.getElementById("payButton").addEventListener("click", startPayment);
  </script>
</body>
</html>
