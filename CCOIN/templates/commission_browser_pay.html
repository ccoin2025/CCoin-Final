<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pay Commission</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
<!-- اصلاح bs58 library -->
<script src="https://cdn.jsdelivr.net/npm/bs58@latest/index.js"></script>

<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
background: #000; color: #fff; min-height: 100vh;
display: flex; align-items: center; justify-content: center; padding: 20px;
}

.container { text-align: center; max-width: 400px; width: 100%; }

.logo { 
width: 80px; height: 80px; background: #ffa500; border-radius: 50%; 
margin: 0 auto 20px; display: flex; align-items: center; justify-content: center; 
font-size: 30px; color: #000; 
}

h1 { font-size: 24px; margin-bottom: 10px; font-weight: 600; }

.subtitle { color: #999; margin-bottom: 30px; font-size: 16px; }

.pay-btn {
background: #ffa500; color: #000; border: none; padding: 15px 30px; border-radius: 10px;
font-size: 16px; font-weight: 600; cursor: pointer; width: 100%; margin-bottom: 20px;
transition: all 0.3s ease;
}

.pay-btn:hover { background: #ff8c00; transform: translateY(-2px); }

.pay-btn:disabled { background: #333; color: #666; cursor: not-allowed; transform: none; }

.amount-info {
background: #1a1a1a; border: 2px solid #333; border-radius: 10px;
padding: 20px; margin: 20px 0;
}

.status { margin-top: 20px; padding: 15px; border-radius: 10px; display: none; }

.status.success { background: #1a5f1a; color: #90ee90; border: 1px solid #228b22; }

.status.error { background: #5f1a1a; color: #ffb3b3; border: 1px solid #dc3545; }

.loading { display: none; margin-top: 20px; }

.spinner { 
width: 20px; height: 20px; border: 2px solid #333; border-top: 2px solid #fff; 
border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto; 
}

@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>

<body>
<div class="container">
<div class="logo">💰</div>
<h1>Pay Commission</h1>
<p class="subtitle">Pay the required commission to complete airdrop</p>

<div class="amount-info">
<h3>Commission Amount</h3>
<div style="font-size: 24px; color: #ffa500; margin: 10px 0;">0.01 SOL</div>
<p style="color: #999; font-size: 14px;">This commission is required to process your airdrop.</p>
</div>

<button id="payBtn" class="pay-btn" onclick="payCommission()">
💳 Pay for Commission
</button>

<div id="loading" class="loading">
<div class="spinner"></div>
<p style="margin-top: 10px;">Processing payment...</p>
</div>

<div id="status" class="status"></div>
</div>

<script>
const USER_ID = new URLSearchParams(window.location.search).get('telegram_id') ||
window.Telegram?.WebApp?.initDataUnsafe?.user?.id ||
'guest';

let isProcessing = false;

async function payCommission() {
if (isProcessing) return;

const payBtn = document.getElementById('payBtn');
const loading = document.getElementById('loading');
const status = document.getElementById('status');

try {
isProcessing = true;
payBtn.disabled = true;
payBtn.textContent = 'Preparing Payment...';
status.style.display = 'none';

// بررسی وجود bs58
if (typeof bs58 === 'undefined' && typeof window.bs58 === 'undefined') {
throw new Error('bs58 library not loaded');
}

// درخواست اطلاعات پرداخت از سرور
const response = await fetch('/api/commission/pay', {
method: 'POST',
headers: {
'Content-Type': 'application/json',
},
body: JSON.stringify({ telegram_id: USER_ID })
});

const paymentData = await response.json();

if (!paymentData.success) {
throw new Error(paymentData.error);
}

payBtn.textContent = 'Opening Phantom App...';

// ایجاد تراکنش واقعی
setTimeout(() => {
if (window.Telegram?.WebApp) {
window.Telegram.WebApp.close();
} else {
window.location.href = `/airdrop?commission_paid=true&telegram_id=${USER_ID}`;
}
}, 2000);

} catch (error) {
console.error('Payment error:', error);
showStatus('error', `❌ Payment failed: ${error.message}`);
resetPayment();
}
}

async function checkPaymentStatus() {
try {
const response = await fetch(`/api/commission/status?telegram_id=${USER_ID}`);
const data = await response.json();

if (data.paid) {
showStatus('success', '✅ Payment verified successfully!');
setTimeout(() => {
if (window.Telegram?.WebApp) {
window.Telegram.WebApp.close();
} else {
window.location.href = `/airdrop?commission_paid=true&telegram_id=${USER_ID}`;
}
}, 2000);
} else {
// ادامه بررسی
setTimeout(checkPaymentStatus, 3000);
}
} catch (error) {
console.error('Check payment error:', error);
// timeout after 30 seconds
setTimeout(() => {
showStatus('error', '🔍 Payment verification timeout. Please try again.');
resetPayment();
}, 30000);
}
}

function resetPayment() {
isProcessing = false;
document.getElementById('payBtn').disabled = false;
document.getElementById('payBtn').textContent = '💳 Pay for Commission';
document.getElementById('payBtn').style.display = 'block';
document.getElementById('loading').style.display = 'none';
}

function showStatus(type, message) {
const status = document.getElementById('status');
status.className = `status ${type}`;
status.textContent = message;
status.style.display = 'block';
}

// بررسی پارامترهای URL برای نتیجه پرداخت
function checkUrlParams() {
const urlParams = new URLSearchParams(window.location.search);
const signature = urlParams.get('signature');
const errorCode = urlParams.get('errorCode');

if (signature) {
showStatus('success', '✅ Payment completed successfully!');
setTimeout(() => {
if (window.Telegram?.WebApp) {
window.Telegram.WebApp.close();
} else {
window.location.href = `/airdrop?commission_paid=true&telegram_id=${USER_ID}`;
}
}, 2000);
} else if (errorCode) {
showStatus('error', `❌ Payment failed: ${errorCode}`);
resetPayment();
}
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
if (window.Telegram?.WebApp) {
window.Telegram.WebApp.ready();
window.Telegram.WebApp.expand();
window.Telegram.WebApp.BackButton.show();
window.Telegram.WebApp.BackButton.onClick(() => {
window.Telegram.WebApp.close();
});
}

checkUrlParams();
});
</script>
</body>
</html>
